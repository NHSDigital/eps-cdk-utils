name: docker image build

on:
    workflow_call:

jobs:
    get_asdf_version:
        runs-on: ubuntu-22.04
        outputs:
            asdf_version: ${{ steps.asdf-version.outputs.version }}
            tag_format: ${{ steps.load-config.outputs.TAG_FORMAT }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Get asdf version
              id: asdf-version
              run: echo "version=$(awk '!/^#/ && NF {print $1; exit}' .tool-versions.asdf)" >> "$GITHUB_OUTPUT"
            - name: Load config value
              id: load-config
              run: |
                  TAG_FORMAT=$(yq '.TAG_FORMAT' .github/config/settings.yml)
                  echo "TAG_FORMAT=$TAG_FORMAT" >> "$GITHUB_OUTPUT"
    package_npm_code:
        runs-on: ubuntu-22.04
        needs: [get_asdf_version]
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  ref: ${{ env.BRANCH_NAME }}

            # using git commit sha for version of action to ensure we have stable version
            - name: Install asdf
              uses: asdf-vm/actions/setup@1902764435ca0dd2f3388eea723a4f92a4eb8302
              with:
                  asdf_version: ${{ needs.get_asdf_version.outputs.asdf_version }}

            - name: Cache asdf
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.asdf
                  key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}
                  restore-keys: |
                      ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}

            - name: Install asdf dependencies in .tool-versions
              uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302
              with:
                  asdf_version: ${{ needs.get_asdf_version.outputs.asdf_version }}
              env:
                  PYTHON_CONFIGURE_OPTS: --enable-shared

            - name: Install dependencies
              run: |
                  make install

            - name: Package code
              run: |
                  make package

            - uses: actions/upload-artifact@v4
              name: Upload packaged code
              with:
                  name: NHSDigital-eps-cdk-constructs
                  path: |
                      lib/NHSDigital-eps-cdk-constructs-1.0.0.tgz
