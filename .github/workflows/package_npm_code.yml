name: docker image build

on:
    workflow_call:

jobs:
    package_npm_code:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  ref: ${{ env.BRANCH_NAME }}

            # using git commit sha for version of action to ensure we have stable version
            - name: Install asdf
              uses: asdf-vm/actions/setup@05e0d2ed97b598bfce82fd30daf324ae0c4570e6
              with:
                  asdf_branch: v0.14.1

            - name: Cache asdf
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.asdf
                  key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}
                  restore-keys: |
                      ${{ runner.os }}-asdf-

            - name: Install asdf dependencies in .tool-versions
              uses: asdf-vm/actions/install@05e0d2ed97b598bfce82fd30daf324ae0c4570e6
              with:
                  asdf_branch: v0.14.1
              env:
                  PYTHON_CONFIGURE_OPTS: --enable-shared

            - name: Install dependencies
              run: |
                  make install

            - name: Package code
              run: |
                  make package

            - uses: actions/upload-artifact@v4
              name: Upload packaged code
              with:
                  name: NHSDigital-eps-cdk-constructs
                  path: |
                      lib/NHSDigital-eps-cdk-constructs-1.0.0.tgz
